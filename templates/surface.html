<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="/static/css/base.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/c3.css" type="text/css"/>
    <script src="/static/js/jquery-1.12.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/d3.min.js"></script>
    <script src="/static/js/c3.min.js"></script>
    <script src="/static/js/bootbox.min.js"></script>
    <script src="/static/js/surface.js"></script>

    <script type="text/javascript" src="/static/js/socket.io.js"></script>

    <script type="text/javascript" charset="utf-8">

        // Global data used by all charts and outputs
        var matrix = {}
        var md = null;

        // Update the global data
        var updateGlobalData= function(newData) {
            matrix[newData.x+','+newData.y] = newData.z * -10;
            if (md!==null)
                md.data([ dataFromFormular(getFromMatrix) ] )
                .transition();
        }

        var getFromMatrix = function(x,y) {
            var key = x+','+y;
            if(matrix.hasOwnProperty(key)) {
                return matrix[key];
            }
            return 0;
        }

        //
        // Websocket
        //

        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function() {
            console.log('Connected');
            socket.emit('my event', {data: 'I\'m connected!'});
            socket.on('newdata', function(data) { updateGlobalData(data) });
            initSurface();
        });

        socket.on('disconnect', function() {
            bootbox.dialog({
                message: "The connection to the server has failed",
                title: "Connection failed",
                buttons: {
                    main: {
                        label: "Refresh Page",
                        className: "btn-success",
                        callback: function() {
                            location.reload();
                        }
                    }
                }
            });
        });


        var yaw=0.5,
                pitch=0.5,
                width = 1000,
                height = 500,
                drag=false;

        function dataFromFormular(func){
            var output=[];
            for(var x=-20;x<20;x++){
                var f0=[];
                output.push(f0);
                for(var y=-20;y<20;y++){
                    f0.push(func(x,y));
                }
            }
            return output;
        }

        var initSurface = function() {

            var selected = dataFromFormular(getFromMatrix);

            var svg=d3.select('body')
                    .append('svg')
                    .attr('height',height)
                    .attr('width',width);

            var group = svg.append("g");

            md=group.data([ selected ])
                    .surface3D(width,height)
                    .surfaceHeight(function(d){
                        return d;
                    }).surfaceColor(function(d){
                        var c=d3.hsl((d+100), 0.6, 0.5).rgb();
                        return "rgb("+parseInt(c.r)+","+parseInt(c.g)+","+parseInt(c.b)+")";
                    });

            svg.on("mousedown",function(){
                drag=[d3.mouse(this),yaw,pitch];
            }).on("mouseup",function(){
                drag=false;
            }).on("mousemove",function(){
                if(drag){
                    var mouse=d3.mouse(this);
                    yaw=drag[1]-(mouse[0]-drag[0][0])/50;
                    pitch=drag[2]+(mouse[1]-drag[0][1])/50;
                    pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch));
                    md.turntable(yaw,pitch);
                }
            });
        }




    </script>

    <style>
        body{
            font-family: sans;
            padding: 0px;
            width: 100%;
            height: 100%;
        }
        svg path{
            stroke: #000;
            stroke-width: 1px;
            stroke: rgba(0,0,0,0.2);
        }
        svg{
            width: 100%;
            height: 100%;
        }
    </style>


</head>
<body>

</body>
</html>