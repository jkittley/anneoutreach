<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello</title>

    <link rel="stylesheet" href="/static/css/base.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css" type="text/css"/>
    <link rel="stylesheet" href="/static/css/c3.css" type="text/css"/>
    <script src="/static/js/jquery-1.12.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/d3.min.js"></script>
    <script src="/static/js/c3.min.js"></script>
    <script src="/static/js/bootbox.min.js"></script>

    <script type="text/javascript" src="/static/js/socket.io.js"></script>

    <script type="text/javascript" charset="utf-8">

        //
        // Global data used by all charts and outputs
        //

        var global_data = {
            'time_axis': [],
            'data_x': [],
            'data_y': [],
            'data_z': [],
        };

        // Update the global data
        var updateGlobalData= function(newData) {
            global_data.time_axis.push(newData.t)
            global_data.data_x.push(newData.x)
            global_data.data_y.push(newData.y)
            global_data.data_z.push(newData.z)
            updateCharts();
        }

        // Callback after global data is updated
        var updateCharts = function() {
            if (chart1!==null) chart1.load({ columns: buildChart1Data() });
        }


        // Get sample of data
        var sampleOfData = function(size) {
            var local_data = {};
            for (var property in global_data) {
                if (global_data.hasOwnProperty(property)) {
                    if (global_data.time_axis.length > size) {
                        local_data[property] = global_data[property].slice(-size);
                    } else {
                        local_data[property] = global_data[property];
                    }
                }
            }
            return local_data;
        }


        //
        // Chart 1
        //

        var chart1 = null;
        var buildChart1Data = function() {

            var local_data = sampleOfData(50);

            var formated = [

                ['data_x'].concat(local_data.data_x),
                ['data_y'].concat(local_data.data_y),
                ['data_z'].concat(local_data.data_z),
            ]
            return formated
        }
        $(document).ready(function() {
            chart1 = c3.generate({
                 bindto: '#chart',
                 data: {

                     names: {

                        data_x: 'X (Left to right)',
                        data_y: 'Y (Back to front)',
                        data_z: 'Z (Up and down)'
                     },

                     columns: buildChart1Data()
                 },
            });
        });


        //
        // Websocket
        //

        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function() {
            console.log('Connected');
            socket.emit('my event', {data: 'I\'m connected!'});
            socket.on('newdata', function(data) { updateGlobalData(data) });
        });

        socket.on('disconnect', function() {
            bootbox.dialog({
              message: "The connection to the server has failed",
              title: "Connection failed",
              buttons: {
                main: {
                  label: "Refresh Page",
                  className: "btn-success",
                  callback: function() {
                    location.reload();
                  }
                }
              }
            });
        });

    </script>
</head>
<body>

<div id="chart"></div>

</body>
</html>