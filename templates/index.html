{% extends "base.html" %}

{% block script %}
    <script src="/static/js/d3.min.js"></script>
    <script src="/static/js/c3.min.js"></script>
    <script type="text/javascript" charset="utf-8">

        var maxHistory = 250;
        var matrix = {}
        var global_data = {
            'time_axis': [],
            'data_x': [],
            'data_y': [],
            'data_z': [],
        };

        // Update the global data
        var updateGlobalData= function(newData) {
            global_data.time_axis.push(newData.timestamp)
            global_data.data_x.push(newData.data.x)
            global_data.data_y.push(newData.data.y)
            global_data.data_z.push(newData.data.z)
            if (global_data.time_axis.length > maxHistory) global_data.time_axis.shift();
            if (global_data.time_axis.length > maxHistory) global_data.data_x.shift();
            if (global_data.time_axis.length > maxHistory) global_data.data_y.shift();
            if (global_data.time_axis.length > maxHistory) global_data.data_z.shift();
            console.log(global_data.time_axis.length);
            updateCharts();
        }

        // Callback after global data is updated
        var updateCharts = function() {
            if (chart1!==null) chart1.load({ columns: buildChart1Data() });
        }

        // Get sample of data
        var sampleOfData = function(size) {
            var local_data = {};
            for (var property in global_data) {
                if (global_data.hasOwnProperty(property)) {
                    if (global_data.time_axis.length > size) {
                        local_data[property] = global_data[property].slice(-size);
                    } else {
                        local_data[property] = global_data[property];
                    }
                }
            }
            return local_data;
        }

        // Build chart 1
        var chart1 = null;
        var buildChart1Data = function() {
            var local_data = sampleOfData(50);
            var formated = [
                ['data_x'].concat(local_data.data_x),
                ['data_y'].concat(local_data.data_y),
                ['data_z'].concat(local_data.data_z),
            ]
            return formated
        }

        $(document).ready(function() {

            // Chart 1
            chart1 = c3.generate({
                 bindto: '#chart',
                 data: {
                     names: {
                        data_x: 'X (Left to right)',
                        data_y: 'Y (Back to front)',
                        data_z: 'Z (Up and down)'
                     },
                     columns: buildChart1Data()
                 },
            });

            // Web socket setup
            sm = new SocketManager(updateGlobalData);
            sm.connect();
        });

    </script>
{% endblock %}

{% block style %}
    <link rel="stylesheet" href="/static/css/c3.css" type="text/css"/>
{% endblock %}

{% block content %}
    <div id="chart"></div>
{% endblock %}